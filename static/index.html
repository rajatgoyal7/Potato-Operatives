<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelMate - Your Treebo Travel Companion</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f8fffe 0%, #e8f5e8 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 450px;
            height: 700px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(76, 175, 80, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(76, 175, 80, 0.1);
        }

        .chat-header {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chat-header p {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .treebo-logo {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
        }

        .treebo-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .header-buttons {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.3s ease;
            display: none;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 6px;
        }

        .message.user .message-content {
            background: #4CAF50;
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: #4CAF50;
            color: white;
        }

        .message.user .message-avatar {
            background: #e8f5e8;
            color: #4CAF50;
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            max-width: 80%;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input input:focus {
            border-color: #4CAF50;
        }

        .send-button {
            width: 44px;
            height: 44px;
            background: #4CAF50;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }

        .send-button:hover {
            background: #45a049;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .option-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .option-button {
            padding: 8px 16px;
            background: #e8f5e8;
            color: #4CAF50;
            border: 1px solid #4CAF50;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-button:hover {
            background: #4CAF50;
            color: white;
        }

        .booking-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .booking-card:hover {
            background: #e8f5e8;
            border-color: #4CAF50;
        }

        .booking-card.selected {
            background: #e8f5e8;
            border-color: #4CAF50;
            border-width: 2px;
        }

        .booking-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .booking-details {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.3;
        }

        .recommendation-card, .service-card, .itinerary-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            margin: 6px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .recommendation-card:hover, .service-card:hover, .itinerary-card:hover {
            border-color: #4CAF50;
            transform: translateY(-1px);
        }

        .rec-name, .service-name, .itinerary-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .rec-details, .service-details, .itinerary-details {
            font-size: 0.8rem;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rec-rating {
            color: #ff9800;
        }

        .price-tag {
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .itinerary-day {
            background: #f0f8f0;
            border-left: 3px solid #4CAF50;
            padding: 10px;
            margin: 8px 0;
            border-radius: 0 8px 8px 0;
        }

        .day-title {
            font-weight: 600;
            color: #4CAF50;
            margin-bottom: 6px;
        }

        .day-activities {
            font-size: 0.85rem;
            color: #555;
            line-height: 1.4;
        }

        /* Enhanced styles for itinerary content only */
        .message.bot .message-content.itinerary-content {
            white-space: pre-line;
            line-height: 1.5;
        }

        .hidden {
            display: none;
        }

        .welcome-animation {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Interactive Recommendation Cards */
        .recommendations-grid {
            display: grid;
            gap: 12px;
            margin-top: 12px;
        }

        .interactive-recommendation-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .interactive-recommendation-card:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .place-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 0;
            flex: 1;
            margin-right: 12px;
        }

        .rating-badge {
            background: #ff9800;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .ai-description {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.4;
            margin: 8px 0 12px 0;
            font-style: italic;
        }

        .place-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: #666;
        }

        .detail-icon {
            margin-right: 6px;
            font-size: 0.9rem;
        }

        .detail-text {
            flex: 1;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .maps-btn {
            background: #4285f4;
            color: white;
        }

        .maps-btn:hover {
            background: #3367d6;
        }

        .details-btn {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .details-btn:hover {
            background: #e8f5e8;
            border-color: #4CAF50;
            color: #4CAF50;
        }

        /* Place Details Modal */
        .place-details-modal {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 8px 0;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.3rem;
            flex: 1;
            margin-right: 12px;
        }

        .rating-large {
            background: #ff9800;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .modal-section {
            margin-bottom: 16px;
        }

        .modal-section h3 {
            margin: 0 0 8px 0;
            color: #4CAF50;
            font-size: 1rem;
            font-weight: 600;
        }

        .ai-description-full {
            font-size: 0.95rem;
            color: #555;
            line-height: 1.5;
            margin: 0;
            font-style: italic;
        }

        .info-grid {
            display: grid;
            gap: 8px;
        }

        .info-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #666;
            min-width: 120px;
            font-size: 0.9rem;
        }

        .info-value {
            color: #333;
            font-size: 0.9rem;
        }

        .info-value a {
            color: #4285f4;
            text-decoration: none;
        }

        .info-value a:hover {
            text-decoration: underline;
        }

        .address-text {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.4;
            margin: 0;
        }

        .opening-hours {
            display: grid;
            gap: 4px;
        }

        .hour-item {
            font-size: 0.85rem;
            color: #555;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .hour-item:last-child {
            border-bottom: none;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
        }

        .action-btn.primary {
            background: #4CAF50;
            color: white;
            flex: 2;
        }

        .action-btn.primary:hover {
            background: #45a049;
        }

        .action-btn.secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e0e0e0;
            flex: 1;
        }

        .action-btn.secondary:hover {
            background: #e8f5e8;
            border-color: #4CAF50;
            color: #4CAF50;
        }

        /* Mobile responsiveness */
        @media (max-width: 480px) {
            .chat-container {
                height: 100vh;
                border-radius: 0;
                max-width: 100%;
            }

            body {
                padding: 0;
            }

            .back-button {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .place-details-grid {
                grid-template-columns: 1fr;
            }

            .card-actions {
                flex-direction: column;
            }

            .modal-actions {
                flex-direction: column;
            }

            .action-btn.primary,
            .action-btn.secondary {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="treebo-logo">
                <img src="https://images.treebohotels.com/images/hotrod/treebo-club-logo-black.svg" alt="Treebo" onerror="this.style.display='none'; this.parentNode.innerHTML='üè®';">
            </div>
            <div class="header-buttons">
                <button class="back-button" id="backButton" onclick="goBack()">‚Üê Back</button>
            </div>
            <h1>TravelMate</h1>
            <p>Your Treebo Travel Companion</p>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be added here dynamically -->
        </div>

        <div class="chat-input-container">
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Type your message..." disabled>
                <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentState = 'welcome';
        let selectedLanguage = 'en';
        let userPhone = '';
        let sessionToken = '';
        let chatSessionId = '';  // Add chat session ID for recommendations
        let availableBookings = [];
        let selectedBooking = null;
        let stateHistory = [];

        // Enhanced language translations with more languages
        const translations = {
            en: {
                welcome: "Hello! Welcome to TravelMate, your Treebo travel companion. I'm here to help you with your bookings, provide personalized recommendations, and create amazing travel experiences.",
                languagePrompt: "Please select your preferred language:",
                phonePrompt: "Great! Now, please enter your phone number so I can find your bookings:",
                searchingBookings: "Searching for your bookings...",
                bookingsFound: "I found your active bookings! Please select which one you'd like assistance with:",
                noBookings: "I couldn't find any active bookings for this phone number. Please check and try again.",
                bookingSelected: "Perfect! I've selected your booking. How can I help you today?",
                recommendationOptions: "What would you like to explore?",
                restaurants: "üçΩÔ∏è Restaurants",
                sightseeing: "üèõÔ∏è Sightseeing",
                shopping: "üõçÔ∏è Shopping",
                nightlife: "üåÉ Nightlife",
                atms: "üèß ATM",
                pharmacy: "üíä Pharmacy",
                rentals: "üöó Car/Bike Rentals",
                itinerary: "üìÖ Travel Itinerary",
                exploreMorePrompt: "Would you like to explore more options or need help with anything else?",
                yes: "‚úÖ Yes",
                no: "‚ùå No",
                thankYouMessage: "Thank you for using TravelMate! Have a wonderful stay at your hotel. Feel free to come back anytime if you need more assistance. Enjoy your trip! üåü",
                startNewChat: "üîÑ Start New Chat",
                closeChatbox: "‚ùå Close Chatbox",
                changeMobileNumber: "üì± Change Mobile Number",
                changeLanguage: "üåê Change Language"
            },
            hi: {
                welcome: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§ü‡•ç‡§∞‡•à‡§µ‡§≤‡§Æ‡•á‡§ü ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à, ‡§Ü‡§™‡§ï‡§æ ‡§ü‡•ç‡§∞‡•Ä‡§¨‡•ã ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§∏‡§æ‡§•‡•Ä‡•§ ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡§®‡•á, ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§∏‡•Å‡§ù‡§æ‡§µ ‡§¶‡•á‡§®‡•á ‡§î‡§∞ ‡§Ö‡§¶‡•ç‡§≠‡•Å‡§§ ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Å ‡§π‡•Ç‡§Å‡•§",
                languagePrompt: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•Ä ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç:",
                phonePrompt: "‡§¨‡§π‡•Å‡§§ ‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ! ‡§Ö‡§¨ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§ñ‡•ã‡§ú ‡§∏‡§ï‡•Ç‡§Ç:",
                searchingBookings: "‡§Ü‡§™‡§ï‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§ñ‡•ã‡§ú‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...",
                bookingsFound: "‡§Æ‡•Å‡§ù‡•á ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§Æ‡§ø‡§≤ ‡§ó‡§à! ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§ï‡§ø‡§∏‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç:",
                noBookings: "‡§á‡§∏ ‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç ‡§î‡§∞ ‡§´‡§ø‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§",
                bookingSelected: "‡§¨‡•á‡§π‡§§‡§∞‡•Ä‡§®! ‡§Æ‡•à‡§Ç‡§®‡•á ‡§Ü‡§™‡§ï‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§ö‡•Å‡§® ‡§≤‡•Ä ‡§π‡•à‡•§ ‡§Ü‡§ú ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•à‡§∏‡•á ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å?",
                recommendationOptions: "‡§Ü‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§ñ‡•ã‡§ú‡§®‡§æ ‡§ö‡§æ‡§π‡•á‡§Ç‡§ó‡•á?",
                restaurants: "üçΩÔ∏è ‡§∞‡•á‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§Ç‡§ü",
                sightseeing: "üèõÔ∏è ‡§¶‡§∞‡•ç‡§∂‡§®‡•Ä‡§Ø ‡§∏‡•ç‡§•‡§≤",
                shopping: "üõçÔ∏è ‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞‡•Ä",
                nightlife: "üåÉ ‡§®‡§æ‡§á‡§ü‡§≤‡§æ‡§á‡§´",
                atms: "üèß ‡§è‡§ü‡•Ä‡§è‡§Æ",
                pharmacy: "üíä ‡§¶‡§µ‡§æ‡§ñ‡§æ‡§®‡§æ",
                rentals: "üöó ‡§ï‡§æ‡§∞/‡§¨‡§æ‡§á‡§ï ‡§ï‡§ø‡§∞‡§æ‡§Ø‡§æ",
                itinerary: "üìÖ ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ",
                packages: "üéÅ ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§™‡•à‡§ï‡•á‡§ú",
                exploreMorePrompt: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§î‡§∞ ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§¶‡•á‡§ñ‡§®‡§æ ‡§ö‡§æ‡§π‡•á‡§Ç‡§ó‡•á ‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§î‡§∞ ‡§Æ‡§¶‡§¶ ‡§ö‡§æ‡§π‡§ø‡§è?",
                yes: "‚úÖ ‡§π‡§æ‡§Å",
                no: "‚ùå ‡§®‡§π‡•Ä‡§Ç",
                thankYouMessage: "‡§ü‡•ç‡§∞‡•à‡§µ‡§≤‡§Æ‡•á‡§ü ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§Ü‡§™‡§ï‡•á ‡§π‡•ã‡§ü‡§≤ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§™‡•ç‡§∞‡§µ‡§æ‡§∏ ‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§π‡•ã‡•§ ‡§Ø‡§¶‡§ø ‡§Ü‡§™‡§ï‡•ã ‡§î‡§∞ ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã ‡§§‡•ã ‡§ï‡§≠‡•Ä ‡§≠‡•Ä ‡§µ‡§æ‡§™‡§∏ ‡§Ü‡§è‡§Ç‡•§ ‡§Ö‡§™‡§®‡•Ä ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§ï‡§æ ‡§Ü‡§®‡§Ç‡§¶ ‡§≤‡•á‡§Ç! üåü",
                startNewChat: "üîÑ ‡§®‡§à ‡§ö‡•à‡§ü ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç",
                closeChatbox: "‚ùå ‡§ö‡•à‡§ü‡§¨‡•â‡§ï‡•ç‡§∏ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
                changeMobileNumber: "üì± ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§¨‡§¶‡§≤‡•á‡§Ç",
                changeLanguage: "üåê ‡§≠‡§æ‡§∑‡§æ ‡§¨‡§¶‡§≤‡•á‡§Ç"
            },
            es: {
                welcome: "¬°Hola! Bienvenido a TravelMate, tu compa√±ero de viaje de Treebo. Estoy aqu√≠ para ayudarte con tus reservas, brindarte recomendaciones personalizadas y crear experiencias de viaje incre√≠bles.",
                languagePrompt: "Por favor selecciona tu idioma preferido:",
                phonePrompt: "¬°Excelente! Ahora, por favor ingresa tu n√∫mero de tel√©fono para encontrar tus reservas:",
                searchingBookings: "Buscando tus reservas...",
                bookingsFound: "¬°Encontr√© tus reservas activas! Por favor selecciona con cu√°l te gustar√≠a que te ayude:",
                noBookings: "No pude encontrar reservas activas para este n√∫mero de tel√©fono. Por favor verifica e intenta de nuevo.",
                bookingSelected: "¬°Perfecto! He seleccionado tu reserva. ¬øC√≥mo puedo ayudarte hoy?",
                recommendationOptions: "¬øQu√© te gustar√≠a explorar?",
                restaurants: "üçΩÔ∏è Restaurantes",
                sightseeing: "üèõÔ∏è Turismo",
                shopping: "üõçÔ∏è Compras",
                nightlife: "üåÉ Vida nocturna",
                atms: "üèß Cajeros",
                pharmacy: "üíä Farmacia",
                rentals: "üöó Alquiler de autos/motos",
                itinerary: "üìÖ Itinerario de viaje",
                packages: "üéÅ Paquetes de viaje",
                exploreMorePrompt: "¬øTe gustar√≠a explorar m√°s opciones o necesitas ayuda con algo m√°s?",
                yes: "‚úÖ S√≠",
                no: "‚ùå No",
                thankYouMessage: "¬°Gracias por usar TravelMate! Que tengas una estancia maravillosa en tu hotel. Vuelve cuando necesites m√°s asistencia. ¬°Disfruta tu viaje! üåü",
                startNewChat: "üîÑ Nuevo Chat",
                closeChatbox: "‚ùå Cerrar Chat",
                changeMobileNumber: "üì± Cambiar N√∫mero",
                changeLanguage: "üåê Cambiar Idioma"
            },
            fr: {
                welcome: "Bonjour! Bienvenue sur TravelMate, votre compagnon de voyage Treebo. Je suis l√† pour vous aider avec vos r√©servations, fournir des recommandations personnalis√©es et cr√©er des exp√©riences de voyage incroyables.",
                languagePrompt: "Veuillez s√©lectionner votre langue pr√©f√©r√©e:",
                phonePrompt: "Parfait! Maintenant, veuillez entrer votre num√©ro de t√©l√©phone pour que je puisse trouver vos r√©servations:",
                searchingBookings: "Recherche de vos r√©servations...",
                bookingsFound: "J'ai trouv√© vos r√©servations actives! Veuillez s√©lectionner celle pour laquelle vous souhaitez de l'aide:",
                noBookings: "Je n'ai pas pu trouver de r√©servations actives pour ce num√©ro de t√©l√©phone. Veuillez v√©rifier et r√©essayer.",
                bookingSelected: "Parfait! J'ai s√©lectionn√© votre r√©servation. Comment puis-je vous aider aujourd'hui?",
                recommendationOptions: "Que souhaitez-vous explorer?",
                restaurants: "üçΩÔ∏è Restaurants",
                sightseeing: "üèõÔ∏è Tourisme",
                shopping: "üõçÔ∏è Shopping",
                nightlife: "üåÉ Vie nocturne",
                atms: "üèß Distributeurs",
                pharmacy: "üíä Pharmacie",
                rentals: "üöó Location auto/moto",
                itinerary: "üìÖ Itin√©raire de voyage",
                packages: "üéÅ Forfaits voyage",
                exploreMorePrompt: "Souhaitez-vous explorer plus d'options ou avez-vous besoin d'aide pour autre chose?",
                yes: "‚úÖ Oui",
                no: "‚ùå Non",
                thankYouMessage: "Merci d'avoir utilis√© TravelMate! Passez un merveilleux s√©jour √† votre h√¥tel. N'h√©sitez pas √† revenir si vous avez besoin d'aide. Bon voyage! üåü",
                startNewChat: "üîÑ Nouveau Chat",
                closeChatbox: "‚ùå Fermer Chat",
                changeMobileNumber: "üì± Changer Num√©ro",
                changeLanguage: "üåê Changer Langue"
            },
            de: {
                welcome: "Hallo! Willkommen bei TravelMate, Ihrem Treebo Reisebegleiter. Ich bin hier, um Ihnen bei Ihren Buchungen zu helfen, personalisierte Empfehlungen zu geben und erstaunliche Reiseerlebnisse zu schaffen.",
                languagePrompt: "Bitte w√§hlen Sie Ihre bevorzugte Sprache:",
                phonePrompt: "Gro√üartig! Bitte geben Sie jetzt Ihre Telefonnummer ein, damit ich Ihre Buchungen finden kann:",
                searchingBookings: "Suche nach Ihren Buchungen...",
                bookingsFound: "Ich habe Ihre aktiven Buchungen gefunden! Bitte w√§hlen Sie aus, bei welcher Sie Hilfe ben√∂tigen:",
                noBookings: "Ich konnte keine aktiven Buchungen f√ºr diese Telefonnummer finden. Bitte √ºberpr√ºfen Sie und versuchen Sie es erneut.",
                bookingSelected: "Perfekt! Ich habe Ihre Buchung ausgew√§hlt. Wie kann ich Ihnen heute helfen?",
                recommendationOptions: "Was m√∂chten Sie erkunden?",
                restaurants: "üçΩÔ∏è Restaurants",
                sightseeing: "üèõÔ∏è Sightseeing",
                shopping: "üõçÔ∏è Einkaufen",
                nightlife: "üåÉ Nachtleben",
                atms: "üèß Geldautomaten",
                pharmacy: "üíä Apotheke",
                rentals: "üöó Auto/Motorrad Vermietung",
                itinerary: "üìÖ Reiseroute",
                packages: "üéÅ Reisepakete",
                exploreMorePrompt: "M√∂chten Sie weitere Optionen erkunden oder ben√∂tigen Sie Hilfe bei etwas anderem?",
                yes: "‚úÖ Ja",
                no: "‚ùå Nein",
                thankYouMessage: "Vielen Dank f√ºr die Nutzung von TravelMate! Haben Sie einen wunderbaren Aufenthalt in Ihrem Hotel. Kommen Sie gerne zur√ºck, wenn Sie weitere Hilfe ben√∂tigen. Genie√üen Sie Ihre Reise! üåü",
                startNewChat: "üîÑ Neuer Chat",
                closeChatbox: "‚ùå Chat Schlie√üen",
                changeMobileNumber: "üì± Nummer √Ñndern",
                changeLanguage: "üåê Sprache √Ñndern"
            }
        };

        // Initialize chatbot
        function initializeChatbot() {
            setTimeout(() => {
                addBotMessage(translations[selectedLanguage].welcome, true);
                setTimeout(() => {
                    showLanguageOptions();
                }, 1000);
            }, 500);
        }

        // State management
        function pushState(state) {
            stateHistory.push(currentState);
            currentState = state;
            updateBackButton();
        }

        function goBack() {
            if (stateHistory.length === 0) {
                return; // No history to go back to
            }

            // Go back one step immediately
            currentState = stateHistory.pop();
            updateBackButton();

            // Handle the current state after going back
            handleBackState();
        }

        function handleBackState() {
            // Handle the current state after going back
            switch (currentState) {
                case 'welcome':
                    // Clear chat and restart
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = '';
                    disableInput();
                    setTimeout(() => {
                        initializeChatbot();
                    }, 500);
                    break;
                case 'language':
                    showLanguageOptions();
                    break;
                case 'phone':
                    showPhonePrompt();
                    break;
                case 'booking_selection':
                    if (availableBookings.length > 0) {
                        showBookingOptions({ bookings: availableBookings.map(b => b.id) });
                    } else {
                        // Fallback: go back to phone input if no bookings available
                        showPhonePrompt();
                    }
                    break;
                case 'chat':
                    showMainOptions();
                    break;
                default:
                    // Fallback to main options if state is unknown
                    showMainOptions();
                    break;
            }
        }

        function updateBackButton() {
            const backButton = document.getElementById('backButton');
            if (stateHistory.length > 0 && currentState !== 'welcome') {
                backButton.style.display = 'block';
                backButton.innerHTML = '‚Üê Back';
            } else {
                backButton.style.display = 'none';
            }
        }



        // Add message to chat
        function addBotMessage(text, isWelcome = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message bot ${isWelcome ? 'welcome-animation' : ''}`;

            messageDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">${text}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function addUserMessage(text) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';

            messageDiv.innerHTML = `
                <div class="message-avatar">üë§</div>
                <div class="message-content">${text}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // Add itinerary message with special formatting
        function addItineraryMessage(text) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            messageDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content itinerary-content">${text}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // Show typing indicator
        function showTyping() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typing-indicator';

            typingDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="typing-indicator" style="display: block;">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTyping() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Show language selection options with more languages
        function showLanguageOptions() {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            const optionsHtml = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    ${translations[selectedLanguage].languagePrompt}
                    <div class="option-buttons">
                        <div class="option-button" onclick="selectLanguage('en')">üá∫üá∏ English</div>
                        <div class="option-button" onclick="selectLanguage('hi')">üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä</div>
                        <div class="option-button" onclick="selectLanguage('es')">üá™üá∏ Espa√±ol</div>
                        <div class="option-button" onclick="selectLanguage('fr')">üá´üá∑ Fran√ßais</div>
                        <div class="option-button" onclick="selectLanguage('de')">üá©üá™ Deutsch</div>
                    </div>
                </div>
            `;

            messageDiv.innerHTML = optionsHtml;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            pushState('language');
        }

        // Language selection
        function selectLanguage(lang) {
            selectedLanguage = lang;
            addUserMessage(document.querySelector(`[onclick="selectLanguage('${lang}')"]`).textContent);

            setTimeout(() => {
                showPhonePrompt();
                pushState('phone');
            }, 500);
        }

        // Show phone prompt with change language option
        function showPhonePrompt() {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            const promptHtml = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    ${translations[selectedLanguage].phonePrompt}
                    <div class="option-buttons" style="margin-top: 15px;">
                        <div class="option-button" onclick="changeLanguage()">${translations[selectedLanguage].changeLanguage}</div>
                    </div>
                </div>
            `;

            messageDiv.innerHTML = promptHtml;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            enableInput();
        }

        // Change mobile number function
        function changeMobileNumber() {
            addUserMessage(translations[selectedLanguage].changeMobileNumber);

            // Clear current booking data
            userPhone = '';
            availableBookings = [];
            selectedBooking = null;

            setTimeout(() => {
                showPhonePrompt();
            }, 500);
        }

        // Change language function
        function changeLanguage() {
            addUserMessage(translations[selectedLanguage].changeLanguage);

            setTimeout(() => {
                showLanguageOptions();
            }, 500);
        }

        // Enable/disable input
        function enableInput() {
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').focus();
        }

        function disableInput() {
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendButton').disabled = true;
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            addUserMessage(message);
            input.value = '';
            disableInput();

            handleUserInput(message);
        }

        // Handle user input based on current state
        function handleUserInput(message) {
            switch (currentState) {
                case 'phone':
                case 'phone_entry':  // Handle both phone states
                    handlePhoneInput(message);
                    break;
                case 'booking_selection':
                    // Handle booking selection if needed
                    break;
                case 'chat':
                    handleChatMessage(message);
                    break;
            }
        }

        // Handle phone number input
        async function handlePhoneInput(phone) {
            console.log('handlePhoneInput called with phone:', phone);
            console.log('Current state:', currentState);

            userPhone = phone;

            showTyping();
            addBotMessage(translations[selectedLanguage].searchingBookings);
            hideTyping();

            try {
                console.log('Starting login API call for phone:', phone);

                // Login user first
                const loginResponse = await fetch('/user/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: phone,
                        name: 'Guest User'
                    })
                });

                console.log('Login response status:', loginResponse.status);

                if (loginResponse.ok) {
                    const loginResult = await loginResponse.json();
                    sessionToken = loginResult.session_token;
                    console.log('Login successful, session token:', sessionToken);

                    // Search for bookings
                    console.log('Starting booking search API call');
                    const searchResponse = await fetch('/bookings/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_token: sessionToken
                        })
                    });

                    console.log('Booking search response status:', searchResponse.status);
                    const searchResult = await searchResponse.json();
                    console.log('Booking search result:', searchResult);
                    console.log('API result structure:', JSON.stringify(searchResult.api_result, null, 2));

                    if (searchResponse.ok && searchResult.bookings && searchResult.bookings.length > 0) {
                        showBookingOptions(searchResult);
                    } else {
                        addBotMessage(translations[selectedLanguage].noBookings);
                        // Stay in phone state for retry
                        enableInput();
                    }
                } else {
                    console.error('Login failed with status:', loginResponse.status);
                    const errorData = await loginResponse.json();
                    console.error('Login error data:', errorData);
                    addBotMessage("Sorry, there was an error. Please try again.");
                    enableInput();
                }
            } catch (error) {
                console.error('Error in handlePhoneInput:', error);
                addBotMessage("Sorry, there was a connection error. Please try again.");
                enableInput();
            }
        }

        // Show booking options with booking ID as title
        function showBookingOptions(searchResult) {
            console.log('showBookingOptions called with:', searchResult);

            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            let bookingsHtml = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    ${translations[selectedLanguage].bookingsFound}
            `;

            // Use real booking data from API response
            let realBookings = [];

            // Check multiple possible API response structures
            let apiBookings = [];

            // Try different possible structures
            if (searchResult.api_result && searchResult.api_result.data) {
                if (searchResult.api_result.data.data && searchResult.api_result.data.data.bookings) {
                    // Nested data structure
                    apiBookings = searchResult.api_result.data.data.bookings;
                    console.log('Using booking data from nested api_result.data.data.bookings');
                } else if (searchResult.api_result.data.bookings) {
                    // Direct data structure
                    apiBookings = searchResult.api_result.data.bookings;
                    console.log('Using booking data from api_result.data.bookings');
                }
            }

            if (apiBookings.length > 0) {
                console.log('Raw API bookings:', apiBookings);

                realBookings = apiBookings.map(booking => {
                    console.log('Processing booking:', booking);
                    const hotelDetails = booking.hotel_details || {};

                    const processedBooking = {
                        id: booking.booking_id,
                        hotel_name: hotelDetails.hotel_name || booking.hotel_name || 'Unknown Hotel',
                        location: hotelDetails.legal_address || hotelDetails.postal_address || booking.location || 'Unknown Location',
                        check_in: booking.check_in || 'Unknown',
                        check_out: booking.check_out || 'Unknown',
                        status: booking.status || 'confirmed',
                        group_code: booking.group_code,
                        hotel_code: booking.hotel_code || booking.hotel_id,
                        guest_name: booking.guest_name || 'Guest',
                        guest_email: booking.guest_email || '',
                        guest_phone: booking.guest_phone || ''
                    };

                    console.log('Processed booking:', processedBooking);
                    return processedBooking;
                });
            } else if (searchResult.bookings && searchResult.bookings.length > 0) {
                console.log('Using fallback booking data from bookings array');
                // Fallback to booking IDs only (this shouldn't happen with real API)
                realBookings = searchResult.bookings.map((bookingId, index) => ({
                    id: bookingId,
                    hotel_name: 'Treebo Hotel',
                    location: 'Location Unknown',
                    check_in: '2025-06-06',
                    check_out: '2025-06-07',
                    status: 'confirmed'
                }));
            }

            console.log('Processed bookings:', realBookings);

            realBookings.forEach((booking, index) => {
                const statusEmoji = booking.status === 'reserved' ? 'üü¢' :
                                  booking.status === 'confirmed' ? 'üü°' :
                                  booking.status === 'checked_in' ? 'üîµ' : '‚úÖ';

                // Extract city from location for cleaner display
                const cityName = extractCityFromLocation(booking.location);

                bookingsHtml += `
                    <div class="booking-card" onclick="selectBooking(${index})">
                        <div class="booking-title">${booking.id}</div>
                        <div class="booking-details">
                            üè® ${booking.hotel_name}<br>
                            üìç ${cityName}<br>
                            üìÖ ${booking.check_in} to ${booking.check_out}<br>
                            ${statusEmoji} ${booking.status}
                        </div>
                    </div>
                `;
            });

            bookingsHtml += `
                    <div class="option-buttons" style="margin-top: 15px;">
                        <div class="option-button" onclick="changeMobileNumber()">${translations[selectedLanguage].changeMobileNumber}</div>
                    </div>
                </div>`;
            messageDiv.innerHTML = bookingsHtml;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();

            availableBookings = realBookings;
            pushState('booking_selection');
        }

        // Select booking
        async function selectBooking(index) {
            selectedBooking = availableBookings[index];

            // Visual feedback
            document.querySelectorAll('.booking-card').forEach((card, i) => {
                if (i === index) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            addUserMessage(`Selected: ${selectedBooking.id}`);

            // Create chat session for the selected booking
            showTyping();

            try {
                const response = await fetch('/chat/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        booking_id: selectedBooking.id,
                        language: selectedLanguage
                    })
                });

                hideTyping();

                if (response.ok) {
                    const result = await response.json();
                    chatSessionId = result.session_id;

                    addBotMessage(translations[selectedLanguage].bookingSelected);
                    setTimeout(() => {
                        showMainOptions();
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    addBotMessage(`Sorry, there was an error setting up your chat session: ${errorData.error || 'Unknown error'}`);
                    // Allow user to try selecting another booking
                }
            } catch (error) {
                hideTyping();
                console.error('Error creating chat session:', error);
                addBotMessage("Sorry, there was a connection error. Please try selecting your booking again.");
            }
        }

        // Show main options with enhanced services
        function showMainOptions() {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            const optionsHtml = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    ${translations[selectedLanguage].recommendationOptions}
                    <div class="option-buttons">
                        <div class="option-button" onclick="getRecommendations('restaurants')">${translations[selectedLanguage].restaurants}</div>
                        <div class="option-button" onclick="getRecommendations('sightseeing')">${translations[selectedLanguage].sightseeing}</div>
                        <div class="option-button" onclick="getRecommendations('shopping')">${translations[selectedLanguage].shopping}</div>
                        <div class="option-button" onclick="getRecommendations('nightlife')">${translations[selectedLanguage].nightlife}</div>
                        <div class="option-button" onclick="getServices('atms')">${translations[selectedLanguage].atms}</div>
                        <div class="option-button" onclick="getServices('pharmacy')">${translations[selectedLanguage].pharmacy}</div>
                        <div class="option-button" onclick="getServices('rentals')">${translations[selectedLanguage].rentals}</div>
                        <div class="option-button" onclick="showItineraryOptions()">${translations[selectedLanguage].itinerary}</div>
                    </div>
                </div>
            `;

            messageDiv.innerHTML = optionsHtml;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();

            pushState('chat');
            enableInput();
        }

        // Get recommendations
        async function getRecommendations(category) {
            addUserMessage(translations[selectedLanguage][category]);

            showTyping();

            try {
                // Check if we have a chat session
                if (!chatSessionId) {
                    throw new Error('No chat session available');
                }

                // Call backend API for real recommendations using MapMyIndia
                const response = await fetch(`/chat/recommendations/${chatSessionId}/${category}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                hideTyping();

                if (data.recommendations && data.recommendations.length > 0) {
                    // Transform backend data to frontend format
                    const transformedRecommendations = data.recommendations.map(rec => ({
                        name: rec.name || 'Unknown',
                        rating: rec.rating ? `${rec.rating}‚≠ê` : 'No rating',
                        distance: rec.distance ? `${rec.distance} km` : 'Distance unknown',
                        type: rec.category || category.slice(0, -1), // Remove 's' from category
                        price: rec.price_level ? '‚Çπ'.repeat(rec.price_level) : 'Price varies',
                        address: rec.address || ''
                    }));

                    showRecommendations(transformedRecommendations, category);
                } else {
                    // Show fallback message if no recommendations found
                    addBotMessage(`Sorry, I couldn't find any ${category} near your location at the moment. Please try again later or contact our concierge for assistance.`);
                    setTimeout(() => {
                        showExploreMoreOptions();
                    }, 1000);
                }

            } catch (error) {
                console.error('Error fetching recommendations:', error);
                hideTyping();

                // Show error message to user
                addBotMessage(`I'm having trouble finding ${category} recommendations right now. Please try again in a moment or contact our concierge for assistance.`);
                setTimeout(() => {
                    showExploreMoreOptions();
                }, 1000);
            }
        }

        // Get services (atm, hospitals, etc.)
        async function getServices(category) {
            addUserMessage(translations[selectedLanguage][category]);

            showTyping();

            try {
                // Check if we have a chat session
                if (!chatSessionId) {
                    throw new Error('No chat session available');
                }

                // Call backend API for real services using MapMyIndia
                const response = await fetch(`/chat/recommendations/${chatSessionId}/${category}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                hideTyping();

                if (data.recommendations && data.recommendations.length > 0) {
                    // Transform backend data to frontend format
                    const transformedServices = data.recommendations.map(service => ({
                        name: service.name || 'Unknown',
                        rating: service.rating ? `${service.rating}‚≠ê` : 'No rating',
                        distance: service.distance ? `${service.distance} km` : 'Distance unknown',
                        type: service.category || category.slice(0, -1), // Remove 's' from category
                        price: getServicePrice(category),
                        address: service.address || ''
                    }));

                    showServices(transformedServices, category);
                } else {
                    // Show fallback message if no services found
                    addBotMessage(`Sorry, I couldn't find any ${category} near your location at the moment. Please try again later or contact our concierge for assistance.`);
                    setTimeout(() => {
                        showExploreMoreOptions();
                    }, 1000);
                }

            } catch (error) {
                console.error('Error fetching services:', error);
                hideTyping();

                // Show error message to user
                addBotMessage(`I'm having trouble finding ${category} right now. Please try again in a moment or contact our concierge for assistance.`);
                setTimeout(() => {
                    showExploreMoreOptions();
                }, 1000);
            }
        }

        // Helper function to get appropriate price for services
        function getServicePrice(category) {
            const servicePrices = {
                'atms': 'Free',
                'pharmacy': 'Medicines',
                'rentals': 'Varies'
            };
            return servicePrices[category] || 'Varies';
        }

        // Helper function to extract city name from full address
        function extractCityFromLocation(location) {
            if (!location) return 'Unknown Location';

            // Common city names in India
            const cities = ['bangalore', 'bengaluru', 'mumbai', 'delhi', 'chennai', 'kolkata', 'hyderabad', 'pune', 'ahmedabad', 'jaipur', 'gurgaon', 'gurugram', 'noida', 'ghaziabad', 'faridabad', 'lucknow', 'kanpur', 'nagpur', 'indore', 'thane', 'bhopal', 'visakhapatnam', 'patna', 'vadodara', 'ludhiana', 'agra', 'nashik', 'meerut', 'rajkot', 'varanasi', 'srinagar', 'aurangabad', 'dhanbad', 'amritsar', 'allahabad', 'ranchi', 'coimbatore', 'jabalpur', 'gwalior', 'vijayawada', 'jodhpur', 'madurai', 'raipur', 'kota', 'guwahati', 'chandigarh', 'solapur', 'hubli', 'tiruchirappalli', 'bareilly', 'mysore', 'tiruppur', 'aligarh', 'jalandhar', 'bhubaneswar', 'salem', 'warangal', 'guntur', 'bhiwandi', 'saharanpur', 'gorakhpur', 'bikaner', 'amravati', 'jamshedpur', 'bhilai', 'cuttack', 'firozabad', 'kochi', 'nellore', 'bhavnagar', 'dehradun', 'durgapur', 'asansol', 'rourkela', 'nanded', 'kolhapur', 'ajmer', 'akola', 'gulbarga', 'jamnagar', 'ujjain', 'loni', 'siliguri', 'jhansi', 'ulhasnagar', 'jammu', 'sangli', 'mangalore', 'erode', 'belgaum', 'ambattur', 'tirunelveli', 'malegaon', 'gaya', 'jalgaon', 'udaipur', 'maheshtala'];

            const lowerLocation = location.toLowerCase();

            // Find city name in the location string
            for (const city of cities) {
                if (lowerLocation.includes(city)) {
                    return city.charAt(0).toUpperCase() + city.slice(1);
                }
            }

            // If no known city found, try to extract from comma-separated parts
            const parts = location.split(',');
            if (parts.length >= 2) {
                // Usually city is the second last part
                const potentialCity = parts[parts.length - 2].trim();
                if (potentialCity.length > 2 && potentialCity.length < 30) {
                    return potentialCity;
                }
            }

            // Return first part if nothing else works
            return parts[0].trim() || 'Unknown Location';
        }

        // Show itinerary options
        function showItineraryOptions() {
            addUserMessage(translations[selectedLanguage].itinerary);

            // Call the backend API to generate itinerary
            generateItineraryFromAPI();
        }

        // Generate itinerary from backend API
        async function generateItineraryFromAPI() {
            if (!chatSessionId) {
                addBotMessage("Sorry, I need a valid chat session to generate your itinerary. Please select a booking first.");
                setTimeout(() => {
                    // Go back to booking selection if no chat session
                    if (availableBookings.length > 0) {
                        showBookingOptions({ bookings: availableBookings.map(b => b.id) });
                    } else {
                        showMainOptions();
                    }
                }, 1000);
                return;
            }

            addBotMessage("ü§ñ Generating your personalized itinerary...");
            showTyping();

            try {
                const response = await fetch(`/chat/itinerary/${chatSessionId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                hideTyping();

                if (response.ok) {
                    const result = await response.json();

                    if (result.itinerary && result.itinerary.message) {
                        // Display the AI-generated itinerary with special formatting
                        addItineraryMessage(result.itinerary.message);

                        // Add options after showing itinerary
                        setTimeout(() => {
                            const messagesContainer = document.getElementById('chatMessages');
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'message bot';

                            const optionsHtml = `
                                <div class="message-avatar">ü§ñ</div>
                                <div class="message-content">
                                    <div class="option-buttons">
                                        <div class="option-button" onclick="showMainOptions()">üîô Back to Menu</div>
                                        <div class="option-button" onclick="changeBooking()">üîÑ Change Booking</div>
                                    </div>
                                </div>
                            `;

                            messageDiv.innerHTML = optionsHtml;
                            messagesContainer.appendChild(messageDiv);
                            scrollToBottom();
                        }, 1000);
                    } else {
                        addBotMessage("Sorry, I couldn't generate an itinerary at the moment. Please try again later.");
                        setTimeout(() => showMainOptions(), 1000);
                    }
                } else {
                    const errorData = await response.json();
                    addBotMessage(`Sorry, there was an error generating your itinerary: ${errorData.error || 'Unknown error'}`);
                    setTimeout(() => showMainOptions(), 1000);
                }
            } catch (error) {
                hideTyping();
                console.error('Error calling itinerary API:', error);
                addBotMessage("Sorry, there was a connection error. Please try again.");
                setTimeout(() => showMainOptions(), 1000);
            }
        }





        // Show recommendations in chat with interactive cards
        function showRecommendations(recommendations, category) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            let recsHtml = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    Here are great ${category} near your hotel:
                    <div class="recommendations-grid">
            `;

            recommendations.forEach((rec, index) => {
                const mapsLink = rec.maps_link || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(rec.name + ' ' + (rec.address || ''))}`;

                recsHtml += `
                    <div class="interactive-recommendation-card" onclick="showPlaceDetails(${index}, '${category}')">
                        <div class="card-header">
                            <h3 class="place-name">${rec.name}</h3>
                            <div class="rating-badge">${rec.rating}</div>
                        </div>

                        <div class="card-content">
                            <div class="place-details-grid">
                                <div class="detail-item">
                                    <span class="detail-icon">üìç</span>
                                    <span class="detail-text">${rec.distance}</span>
                                </div>

                                <div class="detail-item">
                                    <span class="detail-icon">üè∑Ô∏è</span>
                                    <span class="detail-text">${rec.type}</span>
                                </div>

                                <div class="detail-item">
                                    <span class="detail-icon">üí∞</span>
                                    <span class="detail-text">${rec.estimated_pricing || rec.price}</span>
                                </div>

                                ${rec.visit_duration ? `
                                <div class="detail-item">
                                    <span class="detail-icon">‚è±Ô∏è</span>
                                    <span class="detail-text">${rec.visit_duration}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="card-actions">
                            <button class="action-btn maps-btn" onclick="event.stopPropagation(); window.open('${mapsLink}', '_blank')">
                                üìç Maps
                            </button>
                            <button class="action-btn details-btn" onclick="event.stopPropagation(); showPlaceDetails(${index}, '${category}')">
                                ‚ÑπÔ∏è Details
                            </button>
                        </div>
                    </div>
                `;
            });

            recsHtml += `</div></div>`;
            messageDiv.innerHTML = recsHtml;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();

            // Store recommendations for detail view
            window.currentRecommendations = recommendations;

            // Add options after showing recommendations
            setTimeout(() => {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';

                const optionsHtml = `
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <div class="option-buttons">
                            <div class="option-button" onclick="showExploreMoreOptions()">üîç Explore More Options</div>
                            <div class="option-button" onclick="changeBooking()">üîÑ Change Booking</div>
                        </div>
                    </div>
                `;

                messageDiv.innerHTML = optionsHtml;
                messagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }, 1000);
        }

        // Show detailed place information
        function showPlaceDetails(index, category) {
            if (!window.currentRecommendations || !window.currentRecommendations[index]) {
                return;
            }

            const place = window.currentRecommendations[index];
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            const mapsLink = place.maps_link || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name + ' ' + (place.address || ''))}`;

            let detailsHtml = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="place-details-modal">
                        <div class="modal-header">
                            <h2>${place.name}</h2>
                            <div class="rating-large">${place.rating}‚≠ê</div>
                        </div>



                        <div class="modal-section">
                            <h3>Quick Info</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">üìç Distance:</span>
                                    <span class="info-value">${place.distance}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">üè∑Ô∏è Category:</span>
                                    <span class="info-value">${place.type}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">üí∞ Pricing:</span>
                                    <span class="info-value">${place.estimated_pricing || place.price}</span>
                                </div>
                                ${place.visit_duration ? `
                                <div class="info-item">
                                    <span class="info-label">‚è±Ô∏è Duration:</span>
                                    <span class="info-value">${place.visit_duration}</span>
                                </div>
                                ` : ''}
                                ${place.best_time ? `
                                <div class="info-item">
                                    <span class="info-label">üïê Best Time:</span>
                                    <span class="info-value">${place.best_time}</span>
                                </div>
                                ` : ''}
                                ${place.phone ? `
                                <div class="info-item">
                                    <span class="info-label">üìû Phone:</span>
                                    <span class="info-value">${place.phone}</span>
                                </div>
                                ` : ''}
                                ${place.website ? `
                                <div class="info-item">
                                    <span class="info-label">üåê Website:</span>
                                    <span class="info-value"><a href="${place.website}" target="_blank">Visit Website</a></span>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        ${place.address ? `
                        <div class="modal-section">
                            <h3>Address</h3>
                            <p class="address-text">${place.address}</p>
                        </div>
                        ` : ''}

                        <div class="modal-actions">
                            <button class="action-btn primary" onclick="window.open('${mapsLink}', '_blank')">
                                üìç Open in Maps
                            </button>
                            ${place.phone ? `
                            <button class="action-btn secondary" onclick="window.open('tel:${place.phone}', '_self')">
                                üìû Call Now
                            </button>
                            ` : ''}
                            <button class="action-btn secondary" onclick="showMainOptions()">
                                üîô Back to Menu
                            </button>
                        </div>
                    </div>
                </div>
            `;

            messageDiv.innerHTML = detailsHtml;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // Show services in chat using the same interactive cards as recommendations
        function showServices(services, category) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            let servicesHtml = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    Here are nearby ${category}:
                    <div class="recommendations-grid">
            `;

            services.forEach((service, index) => {
                const mapsLink = service.maps_link || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(service.name + ' ' + (service.address || ''))}`;

                servicesHtml += `
                    <div class="interactive-recommendation-card" onclick="showServiceDetails(${index}, '${category}')">
                        <div class="card-header">
                            <h3 class="place-name">${service.name}</h3>
                            <div class="rating-badge">${service.rating}</div>
                        </div>

                        <div class="card-content">
                            <div class="place-details-grid">
                                <div class="detail-item">
                                    <span class="detail-icon">üìç</span>
                                    <span class="detail-text">${service.distance}</span>
                                </div>

                                <div class="detail-item">
                                    <span class="detail-icon">üè∑Ô∏è</span>
                                    <span class="detail-text">${service.type || service.category}</span>
                                </div>

                                <div class="detail-item">
                                    <span class="detail-icon">üí∞</span>
                                    <span class="detail-text">${service.estimated_pricing || service.price}</span>
                                </div>

                                ${service.visit_duration ? `
                                <div class="detail-item">
                                    <span class="detail-icon">‚è±Ô∏è</span>
                                    <span class="detail-text">${service.visit_duration}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="card-actions">
                            <button class="action-btn maps-btn" onclick="event.stopPropagation(); window.open('${mapsLink}', '_blank')">
                                üìç Maps
                            </button>
                            <button class="action-btn details-btn" onclick="event.stopPropagation(); showServiceDetails(${index}, '${category}')">
                                ‚ÑπÔ∏è Details
                            </button>
                        </div>
                    </div>
                `;
            });

            servicesHtml += `</div></div>`;
            messageDiv.innerHTML = servicesHtml;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();

            // Store services for detail view
            window.currentServices = services;

            // Add options after showing services
            setTimeout(() => {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';

                const optionsHtml = `
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <div class="option-buttons">
                            <div class="option-button" onclick="showExploreMoreOptions()">üîç Explore More Options</div>
                            <div class="option-button" onclick="changeBooking()">üîÑ Change Booking</div>
                        </div>
                    </div>
                `;

                messageDiv.innerHTML = optionsHtml;
                messagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }, 1000);
        }

        // Show detailed service information (for ATMs, pharmacy, rentals)
        function showServiceDetails(index, category) {
            if (!window.currentServices || !window.currentServices[index]) {
                return;
            }

            const service = window.currentServices[index];
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            const mapsLink = service.maps_link || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(service.name + ' ' + (service.address || ''))}`;

            let detailsHtml = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="place-details-modal">
                        <div class="modal-header">
                            <h2>${service.name}</h2>
                            <div class="rating-large">${service.rating}‚≠ê</div>
                        </div>

                        <div class="modal-section">
                            <h3>Service Information</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">üìç Distance:</span>
                                    <span class="info-value">${service.distance}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">üè∑Ô∏è Category:</span>
                                    <span class="info-value">${service.type || service.category}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">üí∞ Pricing:</span>
                                    <span class="info-value">${service.estimated_pricing || service.price}</span>
                                </div>
                                ${service.visit_duration ? `
                                <div class="info-item">
                                    <span class="info-label">‚è±Ô∏è Duration:</span>
                                    <span class="info-value">${service.visit_duration}</span>
                                </div>
                                ` : ''}
                                ${service.best_time ? `
                                <div class="info-item">
                                    <span class="info-label">üïê Best Time:</span>
                                    <span class="info-value">${service.best_time}</span>
                                </div>
                                ` : ''}
                                ${service.phone ? `
                                <div class="info-item">
                                    <span class="info-label">üìû Phone:</span>
                                    <span class="info-value">${service.phone}</span>
                                </div>
                                ` : ''}
                                ${service.website ? `
                                <div class="info-item">
                                    <span class="info-label">üåê Website:</span>
                                    <span class="info-value"><a href="${service.website}" target="_blank">Visit Website</a></span>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        ${service.address ? `
                        <div class="modal-section">
                            <h3>Address</h3>
                            <p class="address-text">${service.address}</p>
                        </div>
                        ` : ''}

                        ${service.opening_hours && service.opening_hours.length > 0 ? `
                        <div class="modal-section">
                            <h3>Opening Hours</h3>
                            <div class="opening-hours">
                                ${service.opening_hours.map(hour => `<div class="hour-item">${hour}</div>`).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <div class="modal-actions">
                            <button class="action-btn primary" onclick="window.open('${mapsLink}', '_blank')">
                                üìç Open in Maps
                            </button>
                            ${service.phone ? `
                            <button class="action-btn secondary" onclick="window.open('tel:${service.phone}', '_self')">
                                üìû Call Now
                            </button>
                            ` : ''}
                            <button class="action-btn secondary" onclick="showMainOptions()">
                                üîô Back to Menu
                            </button>
                        </div>
                    </div>
                </div>
            `;

            messageDiv.innerHTML = detailsHtml;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }





        // Book itinerary
        function bookItinerary() {
            addUserMessage("Book This Itinerary");
            addBotMessage("Excellent! I'm creating a personalized booking for your itinerary. Our travel concierge will contact you within 30 minutes to arrange all the details and provide pricing.");

            setTimeout(() => {
                showExploreMoreOptions();
            }, 2000);
        }

        // Show explore more options with Yes/No buttons
        function showExploreMoreOptions() {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            const optionsHtml = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    ${translations[selectedLanguage].exploreMorePrompt}
                    <div class="option-buttons">
                        <div class="option-button" onclick="handleExploreMoreResponse(true)">${translations[selectedLanguage].yes}</div>
                        <div class="option-button" onclick="handleExploreMoreResponse(false)">${translations[selectedLanguage].no}</div>
                    </div>
                </div>
            `;

            messageDiv.innerHTML = optionsHtml;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // Handle Yes/No response for explore more options
        function handleExploreMoreResponse(wantsMore) {
            if (wantsMore) {
                addUserMessage(translations[selectedLanguage].yes);
                setTimeout(() => {
                    showMainOptions();
                }, 500);
            } else {
                addUserMessage(translations[selectedLanguage].no);
                setTimeout(() => {
                    addBotMessage(translations[selectedLanguage].thankYouMessage);
                    setTimeout(() => {
                        showFinalOptions();
                    }, 1000);
                }, 500);
            }
        }

        // Show final options: Start New Chat or Close Chatbox
        function showFinalOptions() {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            const optionsHtml = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="option-buttons">
                        <div class="option-button" onclick="startNewChat()">${translations[selectedLanguage].startNewChat}</div>
                        <div class="option-button" onclick="closeChatbox()">${translations[selectedLanguage].closeChatbox}</div>
                    </div>
                </div>
            `;

            messageDiv.innerHTML = optionsHtml;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // Start a new chat session
        function startNewChat() {
            addUserMessage(translations[selectedLanguage].startNewChat);

            // Reset all state variables
            currentState = 'welcome';
            selectedLanguage = 'en';
            userPhone = '';
            sessionToken = '';
            chatSessionId = '';
            availableBookings = [];
            selectedBooking = null;
            stateHistory = [];

            // Clear chat messages
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';

            // Reset input
            disableInput();
            document.getElementById('messageInput').value = '';

            // Update buttons
            updateBackButton();

            // Restart the chatbot
            setTimeout(() => {
                initializeChatbot();
            }, 500);
        }

        // Close the chatbox
        function closeChatbox() {
            addUserMessage(translations[selectedLanguage].closeChatbox);

            // Add a brief closing message
            setTimeout(() => {
                addBotMessage("Goodbye! üëã");

                // Hide the entire chat container after a short delay
                setTimeout(() => {
                    const chatContainer = document.querySelector('.chat-container');
                    if (chatContainer) {
                        chatContainer.style.display = 'none';
                    }

                    // Alternative: You could also redirect to another page or show a different interface
                    // window.location.href = '/';
                    // Or show a "Chat Closed" overlay
                }, 1000);
            }, 500);
        }

        // Change booking function
        function changeBooking() {
            addUserMessage("Change Booking");

            console.log('changeBooking called, availableBookings:', availableBookings);

            // Check if user has multiple bookings
            if (availableBookings && availableBookings.length > 1) {
                addBotMessage("I can help you switch to a different booking. Here are your available bookings:");

                setTimeout(() => {
                    // Create a search result object to pass to showBookingOptions
                    const searchResult = {
                        bookings: availableBookings.map(b => b.id),
                        api_result: {
                            data: {
                                bookings: availableBookings.map(booking => ({
                                    booking_id: booking.id,
                                    hotel_details: {
                                        hotel_name: booking.hotel_name,
                                        legal_address: booking.location
                                    },
                                    check_in: booking.check_in,
                                    check_out: booking.check_out,
                                    status: booking.status,
                                    group_code: booking.group_code,
                                    hotel_code: booking.hotel_code,
                                    guest_name: booking.guest_name,
                                    guest_email: booking.guest_email,
                                    guest_phone: booking.guest_phone
                                }))
                            }
                        }
                    };

                    showBookingOptions(searchResult);
                }, 1000);
            } else if (availableBookings && availableBookings.length === 1) {
                addBotMessage("You currently have only one booking. To search for different bookings, please provide your phone number again.");

                setTimeout(() => {
                    // Reset to phone number entry
                    currentState = 'phone_entry';
                    userPhone = '';
                    availableBookings = [];
                    selectedBooking = null;

                    addBotMessage("Please enter your phone number to search for bookings:");
                    enableInput();
                }, 1500);
            } else {
                addBotMessage("No bookings found. Please enter your phone number to search for bookings:");

                setTimeout(() => {
                    // Reset to phone number entry
                    currentState = 'phone_entry';
                    userPhone = '';
                    availableBookings = [];
                    selectedBooking = null;
                    enableInput();
                }, 1000);
            }
        }

        // Customize itinerary
        function customizeItinerary() {
            addUserMessage("Customize");
            addBotMessage("I'd love to customize this itinerary for you! Please tell me what changes you'd like - different activities, timing, or specific interests you have.");
            enableInput();
        }

        // Handle chat messages
        function handleChatMessage(message) {
            showTyping();

            setTimeout(() => {
                hideTyping();

                // Simple keyword-based responses
                const lowerMessage = message.toLowerCase();

                if (lowerMessage.includes('food') || lowerMessage.includes('restaurant')) {
                    getRecommendations('restaurants');
                } else if (lowerMessage.includes('sightseeing') || lowerMessage.includes('places')) {
                    getRecommendations('sightseeing');
                } else if (lowerMessage.includes('shopping')) {
                    getRecommendations('shopping');
                } else if (lowerMessage.includes('atm') || lowerMessage.includes('money')) {
                    getServices('atm');
                } else if (lowerMessage.includes('itinerary') || lowerMessage.includes('plan')) {
                    showItineraryOptions();
                } else {
                    addBotMessage("I'm here to help! You can ask me about restaurants, attractions, shopping, services like atm and pharmacy, or I can create a travel itinerary for you. What interests you most?");
                    enableInput();
                }
            }, 1000);
        }

        // Scroll to bottom
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Handle Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initialize when page loads
        window.addEventListener('load', initializeChatbot);
    </script>
</body>
</html>